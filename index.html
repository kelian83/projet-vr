<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Ma première scène A-Frame</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  </head>
  <body>
  <a-scene fog="color: #10008a; density: 0.76; far: 8.3" keyboard-shortcuts="" screenshot="" xr-mode-ui="" device-orientation-permission-ui="" mark-stairs-rotatable>
      <a-asset-item id="monModele" src="assets/Stairs Closed.glb"></a-asset-item>
      <a-asset-item id="monModele2" src="assets/Base.glb"></a-asset-item>
      <a-asset-item id="Herbes" src="assets/grass green.glb"></a-asset-item>
      <a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="180 135 0"></a-entity>      <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="0 135 0"></a-entity>
        <a-entity gltf-model="assets/Base.glb" position="3.39378 0.02296 -9.734" scale="1 24.76 2" rotation="0 45 0"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.5731 2.23124 -8.29348" rotation="180 -45 0" scale="1.5 1 1"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.6189 2.1599 -8.35701" rotation="0 -45 0" scale="1.5 1 1"></a-entity>
      </a-entity><a-entity position="0.00763 0 -0.03422" rotation="0 -90 0">
        <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="180 135 0"></a-entity>      <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="0 135 0"></a-entity>
        <a-entity gltf-model="assets/Base.glb" position="3.39378 0.02296 -9.734" scale="1 24.76 2" rotation="0 45 0"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.5731 2.23124 -8.29348" rotation="180 -45 0" scale="1.5 1 1"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.6189 2.1599 -8.35701" rotation="0 -45 0" scale="1.5 1 1"></a-entity>
      </a-entity><a-entity position="0.00763 0 -0.03422" rotation="0 90 0">
        <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="180 135 0"></a-entity>      <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="0 135 0"></a-entity>
        <a-entity gltf-model="assets/Base.glb" position="3.39378 0.02296 -9.734" scale="1 24.76 2" rotation="0 45 0"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.5731 2.23124 -8.29348" rotation="180 -45 0" scale="1.5 1 1"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.6189 2.1599 -8.35701" rotation="0 -45 0" scale="1.5 1 1"></a-entity>
      </a-entity><a-entity position="0.04158 0 0.00538" rotation="0 180 0">
        <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="180 135 0"></a-entity>      <a-entity gltf-model="assets/Stairs Closed.glb" position="2.02068 0.08154 -6.937" scale="1.5 1 1" rotation="0 135 0"></a-entity>
        <a-entity gltf-model="assets/Base.glb" position="3.39378 0.02296 -9.734" scale="1 24.76 2" rotation="0 45 0"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.5731 2.23124 -8.29348" rotation="180 -45 0" scale="1.5 1 1"></a-entity>
        <a-entity gltf-model="assets/Stairs Closed.glb" position="0.6189 2.1599 -8.35701" rotation="0 -45 0" scale="1.5 1 1"></a-entity>
      </a-entity>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="50" height="50" color="#000847">
      </a-plane>
      <!-- Plafond épais avec trou central (cadre) -->
      <!-- Hypothèses: le sol est centré autour de z=-4 (décalage de la scène). On reproduit ce décalage pour aligner le plafond. -->
      <!-- Paramètres du plafond: largeur totale ~50, ouverture centrale 8x8, épaisseur 1 -->
      <a-entity id="plafond-cadre">
        <!-- Barres Nord/Sud (longueur ~50, profondeur (épaisseur cadre) 21) -->
        <a-box position="0 7 -15" depth="21" scale="1 2 1" height="1" width="50" color="#000847"></a-box>
        <a-box position="0 7 15" depth="21" scale="1 2 1" height="1" width="50" color="#000847"></a-box>
        <!-- Barres Ouest/Est (longueur ~8+2*21=50, mais on réalise des latérales de 16 de profondeur) -->
        <a-box position="-15 7 0" rotation="0 90 0" scale="1 2 1" depth="21" height="1" width="9" color="#000847"></a-box>
        <a-box position="15 7 0" scale="1 2 1" rotation="0 90 0" depth="21" height="1" width="9" color="#000847"></a-box>
      </a-entity>
      <a-entity id="lampadaire" position="-4.08915 0 -5.77692" rotation="0 -45 0">
        <a-cylinder position="0 0.15 0" radius="0.12" height="0.3" color="#3a3a3a"></a-cylinder>
        <a-cylinder position="0 1.9 0" radius="0.05" height="3.8" color="#4a4a4a"></a-cylinder>
        <a-cylinder position="0.5 3.5 0" rotation="0 0 90" radius="0.03" height="1.0" color="#4a4a4a"></a-cylinder>
        <a-sphere position="1 3.5 0" radius="0.5" color="#ffffff" material="emissive: #ffd27a; emissiveIntensity: 1.6"></a-sphere>
        <a-light type="point" position="1 3.5 0" color="#ffd27a" intensity="10" distance="18" decay="2" cast-shadow="true"></a-light>
      </a-entity><a-entity id="lampadaire-2" position="-5.19538 0 3.70934" rotation="0 45 0">
        <a-cylinder position="0 0.15 0" radius="0.12" height="0.3" color="#3a3a3a"></a-cylinder>
        <a-cylinder position="0 1.9 0" radius="0.05" height="3.8" color="#4a4a4a"></a-cylinder>
        <a-cylinder position="0.5 3.5 0" rotation="0 0 90" radius="0.03" height="1.0" color="#4a4a4a"></a-cylinder>
        <a-sphere position="1 3.5 0" radius="0.5" color="#ffffff" material="emissive: #ffd27a; emissiveIntensity: 1.6"></a-sphere>
        <a-light type="point" position="1 3.5 0" color="#ffd27a" intensity="10" distance="18" decay="2" cast-shadow="true"></a-light>
      </a-entity><a-entity id="lampadaire-3" position="4.84424 0 -4.27002" rotation="0 225 0">
        <a-cylinder position="0 0.15 0" radius="0.12" height="0.3" color="#3a3a3a"></a-cylinder>
        <a-cylinder position="0 1.9 0" radius="0.05" height="3.8" color="#4a4a4a"></a-cylinder>
        <a-cylinder position="0.5 3.5 0" rotation="0 0 90" radius="0.03" height="1.0" color="#4a4a4a"></a-cylinder>
        <a-sphere position="1 3.5 0" radius="0.5" color="#ffffff" material="emissive: #ffd27a; emissiveIntensity: 1.6"></a-sphere>
        <a-light type="point" position="1 3.5 0" color="#ffd27a" intensity="10" distance="18" decay="2" cast-shadow="true"></a-light>
      </a-entity><a-entity id="lampadaire-4" position="4.84424 0 4.43013" rotation="0 135 0">
        <a-cylinder position="0 0.15 0" radius="0.12" height="0.3" color="#3a3a3a"></a-cylinder>
        <a-cylinder position="0 1.9 0" radius="0.05" height="3.8" color="#4a4a4a"></a-cylinder>
        <a-cylinder position="0.5 3.5 0" rotation="0 0 90" radius="0.03" height="1.0" color="#4a4a4a"></a-cylinder>
        <a-sphere position="1 3.5 0" radius="0.5" color="#ffffff" material="emissive: #ffd27a; emissiveIntensity: 1.6"></a-sphere>
        <a-light type="point" position="1 3.5 0" color="#ffd27a" intensity="10" distance="18" decay="2" cast-shadow="true"></a-light>
      </a-entity>
      <script>
        AFRAME.registerComponent('scatter-grass', {
          schema: {
            count: {type: 'int', default: 30},
            width: {type: 'number', default: 14},
            depth: {type: 'number', default: 14},
            y: {type: 'number', default: 0},
            minScale: {type: 'number', default: 2.6},
            maxScale: {type: 'number', default: 3.4}
          },
          init: function () {
            const d = this.data;
            for (let i = 0; i < d.count; i++) {
              const e = document.createElement('a-entity');
              const x = (Math.random() - 0.5) * d.width;
              const z = (Math.random() - 0.5) * d.depth;
              const ry = Math.random() * 360;
              const s = d.minScale + Math.random() * (d.maxScale - d.minScale);
              e.setAttribute('gltf-model', '#Herbes');
              e.setAttribute('position', {x, y: d.y, z});
              e.setAttribute('rotation', {x: 0, y: ry, z: 0});
              e.setAttribute('scale', {x: s, y: s, z: s});
              // Animations : balancement doux (rotation Y) et léger flottement (position Y)
              const swayAmp = 5 + Math.random() * 6; // amplitude +- en degrés (5 à 11)
              const swayDur = 1800 + Math.floor(Math.random() * 1400); // 1800-3200ms
              const swayDelay = Math.floor(Math.random() * 1000); // 0-1000ms
              const yFrom = ry - swayAmp;
              const yTo = ry + swayAmp;
              e.setAttribute('animation__sway', {
                property: 'rotation',
                from: `0 ${yFrom} 0`,
                to: `0 ${yTo} 0`,
                dir: 'alternate',
                loop: true,
                easing: 'easeInOutSine',
                dur: swayDur,
                delay: swayDelay
              });

              const bobAmp = 0.06 + Math.random() * 0.08; // 0.06 à 0.14 unités
              const bobDur = 1400 + Math.floor(Math.random() * 1400); // 1400-2800ms
              const bobDelay = Math.floor(Math.random() * 1000); // 0-1000ms
              e.setAttribute('animation__bob', {
                property: 'position',
                from: `${x} ${d.y - bobAmp} ${z}`,
                to: `${x} ${d.y + bobAmp} ${z}`,
                dir: 'alternate',
                loop: true,
                easing: 'easeInOutSine',
                dur: bobDur,
                delay: bobDelay
              });
              this.el.appendChild(e);
            }
          }
        });

        // Marquer automatiquement les escaliers comme rotatables (ceux qui utilisent Stairs Closed.glb)
        AFRAME.registerComponent('mark-stairs-rotatable', {
          init: function () {
            const mark = () => {
              const stairs = this.el.querySelectorAll('a-entity[gltf-model*="Stairs Closed.glb"], [gltf-model*="Stairs Closed.glb"]');
              stairs.forEach(el => el.classList.add('rotatable'));
            };
            if (this.el.hasLoaded) mark(); else this.el.addEventListener('loaded', mark);
          }
        });

        // Composant contrôleur: maintenir la gâchette pour faire tourner la cible intersectée
        AFRAME.registerComponent('controller-rotate', {
          schema: { speed: { type: 'number', default: 45 } }, // degrés/sec
          init: function () {
            this.isHolding = false;
            this.targetEl = null;
            this._onDown = this.onDown.bind(this);
            this._onUp = this.onUp.bind(this);
            // Écouter trigger (et squeeze pour compatibilité)
            this.el.addEventListener('triggerdown', this._onDown);
            this.el.addEventListener('triggerup', this._onUp);
            this.el.addEventListener('squeezestart', this._onDown);
            this.el.addEventListener('squeezeend', this._onUp);
          },
          remove: function () {
            this.el.removeEventListener('triggerdown', this._onDown);
            this.el.removeEventListener('triggerup', this._onUp);
            this.el.removeEventListener('squeezestart', this._onDown);
            this.el.removeEventListener('squeezeend', this._onUp);
          },
          onDown: function () {
            const rc = this.el.components.raycaster;
            if (!rc) { this.isHolding = false; this.targetEl = null; return; }
            const hits = rc.intersections || [];
            if (hits.length > 0) {
              const hitEl = hits[0].object && hits[0].object.el ? hits[0].object.el : hits[0].el;
              // Remonter au parent si l'intersection cible un mesh interne
              this.targetEl = hitEl && hitEl.classList && hitEl.classList.contains('rotatable') ? hitEl : (hitEl && hitEl.closest ? hitEl.closest('.rotatable') : null);
              if (this.targetEl) this.isHolding = true;
            }
          },
          onUp: function () {
            this.isHolding = false;
            this.targetEl = null;
          },
          tick: function (time, dt) {
            if (!this.isHolding || !this.targetEl || !dt) return;
            const rot = this.targetEl.getAttribute('rotation');
            const step = (this.data.speed * dt) / 1000; // degrés
            this.targetEl.setAttribute('rotation', { x: rot.x, y: rot.y + step, z: rot.z });
          }
        });
      </script>
      <a-entity scatter-grass="count: 32; width: 16; depth: 16; y: 0; minScale: 2.7; maxScale: 3.5"></a-entity>
  <a-sky color="#ECECEC"></a-sky>
  <a-camera position="0 1.6 0" rotation="-33.23155211758776 -319.93963280105135 0"> </a-camera>
      
  <!-- Contrôleurs VR avec laser et rotation au maintien de la gâchette -->
  <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: .rotatable; far: 12" controller-rotate="speed: 45"></a-entity>
  <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: .rotatable; far: 12" controller-rotate="speed: 45"></a-entity>
      <!-- <a-light type="ambient" color="#9fb2ff" intensity="0.6"></a-light>
      <a-light type="hemisphere" color="#cfd8ff" groundcolor="#0a0052" intensity="0.7"></a-light> -->
    </a-scene>
  </body>
</html>
